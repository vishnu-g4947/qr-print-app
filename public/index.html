<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintMitra - Self-Service Printing</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 32px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        .status-dot.offline { background: #f44336; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .content { padding: 30px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        .upload-area:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-area.dragover { background: #e8ebff; border-color: #764ba2; }
        .upload-area.uploading { pointer-events: none; opacity: 0.6; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        input[type="file"] { display: none; }
        .file-info { background: #f8f9ff; padding: 15px; border-radius: 10px; margin: 15px 0; display: none; }
        .file-info.show { display: block; }
        .file-name { font-weight: 600; color: #667eea; margin-bottom: 5px; }
        .option-group { margin: 20px 0; }
        .option-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #333; }
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-option { flex: 1; min-width: 120px; }
        .radio-option input[type="radio"] { display: none; }
        .radio-option label {
            display: block;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .radio-option input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .radio-option label:hover { border-color: #667eea; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; }
        .price-summary { background: #f8f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .price-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 15px; }
        .price-row.total {
            border-top: 2px solid #667eea;
            padding-top: 10px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-secondary:hover { background: #f8f9ff; }
        .success-animation { text-align: center; padding: 40px 20px; }
        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: inline-block;
            stroke-width: 3;
            stroke: #4CAF50;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #4CAF50;
            animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
        }
        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: #4CAF50;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 40px #4CAF50; } }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .error-message.show { display: block; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 30px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loader"></div>
            <p style="margin-top: 15px; color: #333;">Processing...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="status-indicator" id="statusIndicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Checking...</span>
            </div>
            <h1>ðŸ“„ PrintMitra</h1>
            <p>Quick & Easy Self-Service Printing</p>
        </div>

        <div class="content">
            <div class="step active" id="step1">
                <h2 style="margin-bottom: 20px;">Upload Your Document</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ðŸ“¤</div>
                    <h3>Click or Drag & Drop</h3>
                    <p style="color: #666; margin-top: 10px;">PDF, DOC, DOCX (Max 10MB)</p>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx">
                </div>
                <div class="file-info" id="fileInfo">
                    <div class="file-name" id="fileName"></div>
                    <div id="fileSize"></div>
                    <div id="pageCount"></div>
                </div>
                <div class="error-message" id="error1"></div>
                <button class="btn btn-primary" id="nextBtn1" disabled>Continue to Print Options</button>
            </div>

            <div class="step" id="step2">
                <h2 style="margin-bottom: 20px;">Print Settings</h2>
                <div class="option-group">
                    <label>Color Mode</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="color" id="bw" value="bw" checked>
                            <label for="bw">Black & White<br><small>â‚¹2/page</small></label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="color" id="color" value="color">
                            <label for="color">Color<br><small>â‚¹8/page</small></label>
                        </div>
                    </div>
                </div>
                <div class="option-group">
                    <label>Paper Size</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="size" id="a4" value="a4" checked>
                            <label for="a4">A4</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="size" id="letter" value="letter">
                            <label for="letter">Letter</label>
                        </div>
                    </div>
                </div>
                <div class="option-group">
                    <label>Sides</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" name="sides" id="single" value="single" checked>
                            <label for="single">Single-Sided</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" name="sides" id="double" value="double">
                            <label for="double">Double-Sided</label>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label for="copies">Number of Copies</label>
                    <input type="number" id="copies" min="1" max="100" value="1">
                </div>
                <div class="input-group">
                    <label for="pageRange">Page Range (optional)</label>
                    <input type="text" id="pageRange" placeholder="e.g., 1-5, 8, 10-12">
                </div>
                <button class="btn btn-secondary" id="backBtn1">Back</button>
                <button class="btn btn-primary" id="nextBtn2">Continue to Payment</button>
            </div>

            <div class="step" id="step3">
                <h2 style="margin-bottom: 20px;">Payment Summary</h2>
                <div class="price-summary" id="priceSummary"></div>
                <div class="input-group">
                    <label for="email">Email (for receipt)</label>
                    <input type="email" id="email" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" placeholder="+91 XXXXX XXXXX">
                </div>
                <div class="error-message" id="error3"></div>
                <button class="btn btn-secondary" id="backBtn2">Back</button>
                <button class="btn btn-primary" id="payBtn">Pay Now</button>
            </div>

            <div class="step" id="step4">
                <div class="success-animation">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                        <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                    <h2 style="margin: 20px 0; color: #4CAF50;">Payment Successful!</h2>
                    <p style="color: #666; margin-bottom: 20px;">Your print job has been sent to the printer.</p>
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                        <p style="margin-top: 10px;"><strong>Collection Code:</strong> <span id="collectionCode" style="font-size: 24px; color: #667eea; font-weight: 700;"></span></p>
                    </div>
                    <p style="color: #666; font-size: 14px;">Please collect your documents from the printer tray.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Print Another Document</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let RAZORPAY_KEY = '';
        let currentStep = 1;
        let uploadedFileId = null;
        let pageCount = 0;
        let currentOrder = null;
        let printSettings = { color: 'bw', size: 'a4', sides: 'single', copies: 1, pageRange: '' };
        const PRICING = { bw: 2, color: 8 };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const pageCountElement = document.getElementById('pageCount');
        const loadingOverlay = document.getElementById('loadingOverlay');

        checkSystemStatus();
        loadRazorpayKey();

        async function loadRazorpayKey() {
            try {
                const response = await fetch(`${API_URL}/config`);
                const data = await response.json();
                RAZORPAY_KEY = data.razorpayKey;
            } catch (error) {
                console.error('Config load failed:', error);
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                if (data.success && data.status.printer.status === 'online') {
                    statusDot.classList.remove('offline');
                    statusText.textContent = 'Online';
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = 'Offline';
                }
            } catch (error) {
                document.getElementById('statusDot').classList.add('offline');
                document.getElementById('statusText').textContent = 'Offline';
            }
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
        });

        async function handleFileUpload(file) {
            const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const maxSize = 10 * 1024 * 1024;

            if (!validTypes.includes(file.type)) {
                showError('error1', 'Please upload a PDF or DOC file.');
                return;
            }
            if (file.size > maxSize) {
                showError('error1', 'File size must be less than 10MB.');
                return;
            }

            showLoading(true);
            uploadArea.classList.add('uploading');

            try {
                const formData = new FormData();
                formData.append('document', file);

                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Upload failed');

                uploadedFileId = data.file.id;
                pageCount = data.file.pageCount;

                fileName.textContent = data.file.name;
                fileSize.textContent = `Size: ${(data.file.size / 1024 / 1024).toFixed(2)} MB`;
                pageCountElement.textContent = `Pages: ${pageCount}`;
                
                fileInfo.classList.add('show');
                document.getElementById('nextBtn1').disabled = false;

            } catch (error) {
                showError('error1', error.message || 'Failed to upload file.');
            } finally {
                showLoading(false);
                uploadArea.classList.remove('uploading');
            }
        }

        document.getElementById('nextBtn1').addEventListener('click', () => goToStep(2));
        document.getElementById('nextBtn2').addEventListener('click', () => {
            updatePrintSettings();
            showPriceSummary();
            goToStep(3);
        });
        document.getElementById('backBtn1').addEventListener('click', () => goToStep(1));
        document.getElementById('backBtn2').addEventListener('click', () => goToStep(2));

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function updatePrintSettings() {
            printSettings.color = document.querySelector('input[name="color"]:checked').value;
            printSettings.size = document.querySelector('input[name="size"]:checked').value;
            printSettings.sides = document.querySelector('input[name="sides"]:checked').value;
            printSettings.copies = parseInt(document.getElementById('copies').value);
            printSettings.pageRange = document.getElementById('pageRange').value;
        }

        function calculateTotal() {
            const pricePerPage = PRICING[printSettings.color];
            let totalPages = pageCount;
            if (printSettings.pageRange) {
                totalPages = calculatePageRangeCount(printSettings.pageRange, pageCount);
            }
            return totalPages * printSettings.copies * pricePerPage;
        }

        function calculatePageRangeCount(pageRange, maxPages) {
            if (!pageRange) return maxPages;
            const ranges = pageRange.split(',');
            let count = 0;
            ranges.forEach(range => {
                range = range.trim();
                if (range.includes('-')) {
                    const [start, end] = range.split('-').map(n => parseInt(n.trim()));
                    count += Math.min(end, maxPages) - Math.max(start, 1) + 1;
                } else {
                    const page = parseInt(range);
                    if (page <= maxPages) count++;
                }
            });
            return Math.max(count, 0);
        }

        function showPriceSummary() {
            const pricePerPage = PRICING[printSettings.color];
            let totalPages = pageCount;
            if (printSettings.pageRange) {
                totalPages = calculatePageRangeCount(printSettings.pageRange, pageCount);
            }
            const finalPages = totalPages * printSettings.copies;
            const total = calculateTotal();

            document.getElementById('priceSummary').innerHTML = `
                <div class="price-row"><span>Pages:</span><span>${totalPages} Ã— ${printSettings.copies} = ${finalPages} pages</span></div>
                <div class="price-row"><span>Mode:</span><span>${printSettings.color === 'bw' ? 'Black & White' : 'Color'}</span></div>
                <div class="price-row"><span>Rate:</span><span>â‚¹${pricePerPage}/page</span></div>
                <div class="price-row total"><span>Total:</span><span>â‚¹${total}</span></div>
            `;
        }

        document.getElementById('payBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            if (!email || !phone) {
                showError('error3', 'Please provide email and phone number.');
                return;
            }
            if (!validateEmail(email)) {
                showError('error3', 'Please provide a valid email address.');
                return;
            }
            await createOrder(email, phone);
        });

        async function createOrder(email, phone) {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/create-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId: uploadedFileId, printSettings, email, phone })
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Failed to create order');

                currentOrder = data.order;
                initiatePayment(email, phone);
            } catch (error) {
                showError('error3', error.message || 'Failed to create order.');
            } finally {
                showLoading(false);
            }
        }

        function initiatePayment(email, phone) {
            const options = {
                key: RAZORPAY_KEY,
                amount: currentOrder.amount * 100,
                currency: currentOrder.currency,
                name: 'PrintMitra',
                description: 'Print Service Payment',
                order_id: currentOrder.id,
                prefill: { email, contact: phone },
                theme: { color: '#667eea' },
                handler: function(response) { verifyPayment(response); },
                modal: {
                    ondismiss: function() {
                        showError('error3', 'Payment cancelled.');
                    }
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        }

        async function verifyPayment(response) {
            showLoading(true);
            try {
                const verifyResponse = await fetch(`${API_URL}/verify-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(response)
                });

                const data = await verifyResponse.json();
                if (!data.success) throw new Error(data.error || 'Payment verification failed');

                document.getElementById('orderId').textContent = data.order.orderId;
                document.getElementById('collectionCode').textContent = data.order.collectionCode;
                goToStep(4);
            } catch (error) {
                showError('error3', error.message || 'Payment verification failed.');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('show', show);
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.add('show');
            setTimeout(() => errorElement.classList.remove('show'), 5000);
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        document.querySelectorAll('input[name="color"], input[name="sides"], #copies').forEach(element => {
            element.addEventListener('change', updatePrintSettings);
        });

        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>